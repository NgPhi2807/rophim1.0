---
export const prerender = true;

export async function getStaticPaths() {
  const staticTheLoaiList = [
    { id: 1, ten: "Hành Động", slug: "hanh-dong" },
    { id: 2, ten: "Cổ Trang", slug: "co-trang" },
    { id: 3, ten: "Viễn Tưởng", slug: "vien-tuong" },
    { id: 4, ten: "Bí Ẩn", slug: "bi-an" },
    { id: 5, ten: "Tâm Lý", slug: "tam-ly" },
    { id: 6, ten: "Âm Nhạc", slug: "am-nhac" },
    { id: 7, ten: "Phiêu Lưu", slug: "phieu-luu" },
    { id: 8, ten: "Chính Kịch", slug: "chinh-kich" },
    { id: 9, ten: "Khoa Học", slug: "khoa-hoc" },
    { id: 10, ten: "Học Đường", slug: "hoc-duong" },
    { id: 11, ten: "Võ Thuật", slug: "vo-thuat" },
    { id: 12, ten: "Chiến Tranh", slug: "chien-tranh" },
    { id: 18, ten: "Hình Sự", slug: "hinh-su" },
    { id: 19, ten: "Gia Đình", slug: "gia-dinh" },
    { id: 20, ten: "Tình Cảm", slug: "tinh-cam" },
    { id: 21, ten: "Thần Thoại", slug: "than-thoai" },
    { id: 22, ten: "Thể Thao", slug: "the-thao" },
    { id: 23, ten: "Kinh Dị", slug: "kinh-di" },
    { id: 24, ten: "Kinh Điển", slug: "kinh-dien" },
  ];

  return staticTheLoaiList.map((theLoai) => ({
    params: { slug: theLoai.slug },
  }));
}

import BaseLayout from "../../layouts/Layout.astro";
import Header from "../../components/Header";
import CategoryMovies from "../../components/MovieType/MovieCategory";
import TopMovies from "../../components/TodayMovies";

const slug = Astro.params.slug;
const initialPage = 1;
const limit = 60;
const BASE_URL = "https://phimapi.com";
const API_URL = `${BASE_URL}/v1/api/the-loai/${slug}?page=${initialPage}&limit=${limit}&sort_field=_id&sort_type=dsc`;
const TOP_URL = `${BASE_URL}/v1/api/danh-sach/phim-bo?page=1&sort_field=_id&sort_type=dsc&limit=10`;

const fetchJson = async (url: string) => {
  try {
    const res = await fetch(url);
    if (!res.ok) throw new Error(`Lỗi khi fetch API: ${url}`);
    return await res.json();
  } catch (err) {
    console.error(`Error fetching ${url}:`, err); // Log the error for debugging
    return null;
  }
};

const [categoryResponse, topResponse] = await Promise.all([
  fetchJson(API_URL),
  fetchJson(TOP_URL),
]);

const categoryData = categoryResponse?.data;
const topmovies = topResponse?.data.items || [];
const currentCategoryName = categoryData?.titlePage || slug; // Use optional chaining
const capitalizedCategoryName = currentCategoryName
  .split(" ")
  .map((word: string) => word.charAt(0).toUpperCase() + word.slice(1))
  .join(" ");

if (!categoryData) {
  return new Response("Không thể lấy dữ liệu thể loại. Vui lòng thử lại sau.", {
    status: 500,
  });
}

const siteUrl = "https://phimmoii.top";
const currentUrl = `${siteUrl}/the-loai/${slug}`;
const titleTag = `Phim ${currentCategoryName} Mới Nhất | Tuyển Tập Phim Hay 2025 | Phimmoi`;
const seoDescription = `Xem phim ${capitalizedCategoryName} tại Phimmoi Vietsub HD miễn phí, chất lượng hình ảnh đỉnh cao. Cập nhật nhanh nhất những bộ phim hấp dẫn, đảm bảo trải nghiệm xem phim tuyệt vời!`;
const ogImage = categoryData?.items?.[0]?.thumb_url || `${siteUrl}/logo.svg`;

// Consolidated Schema.org data
const schemaData = {
  "@context": "https://schema.org",
  "@graph": [
    {
      "@type": "BreadcrumbList",
      "@id": `${currentUrl}#breadcrumb`,
      itemListElement: [
        {
          "@type": "ListItem",
          position: 1,
          name: "Trang chủ",
          item: siteUrl,
        },
        {
          "@type": "ListItem",
          position: 2,
          name: currentCategoryName,
          item: currentUrl,
        },
      ],
    },
    {
      "@type": "CollectionPage",
      "@id": currentUrl,
      url: currentUrl,
      name: titleTag,
      description: seoDescription,
      isPartOf: {
        "@id": `${siteUrl}#website`,
      },
      breadcrumb: {
        "@id": `${currentUrl}#breadcrumb`,
      },
      primaryImageOfPage: {
        "@id": `${currentUrl}#primaryimage`,
      },
      image: {
        "@id": `${currentUrl}#primaryimage`,
      },
      inLanguage: "vi",
    },
    {
      "@type": "ImageObject",
      "@id": `${currentUrl}#primaryimage`,
      url: ogImage,
      contentUrl: ogImage,
      inLanguage: "vi",
    },
    {
      "@type": "WebSite",
      "@id": `${siteUrl}#website`,
      url: siteUrl,
      name: "Phimmoi",
      description: "Xem Phim Vietsub HD tại Phimmoi",
      publisher: {
        "@id": `${siteUrl}#organization`,
      },
      potentialAction: {
        "@type": "SearchAction",
        target: `${siteUrl}/tim-kiem?q={search_term_string}`,
        "query-input": "required name=search_term_string",
      },
      inLanguage: "vi",
    },
    {
      "@type": "Organization",
      "@id": `${siteUrl}#organization`,
      name: "Phimmoi",
      url: siteUrl,
      logo: {
        "@type": "ImageObject",
        "@id": `${siteUrl}#/schema/logo/image/`,
        url: `${siteUrl}/logo.svg`,
        contentUrl: `${siteUrl}/logo.svg`,
        caption: "Phimmoi",
        inLanguage: "vi",
      },
    },
  ],
};
---

<BaseLayout>
  <Fragment slot="head">
    <title>{titleTag}</title>
    <meta name="description" content={seoDescription} />
    <meta name="robots" content="index, follow" />
    <link rel="canonical" href={currentUrl} />

    {/* Open Graph Tags */}
    <meta property="og:title" content={titleTag} />
    <meta property="og:description" content={seoDescription} />
    <meta property="og:url" content={currentUrl} />
    <meta property="og:type" content="website" />
    <meta property="og:locale" content="vi_VN" />
    <meta property="og:site_name" content="Phimmoi" />
    <meta property="og:image" content={ogImage} />

    {/* Twitter Card Tags */}
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content={titleTag} />
    <meta name="twitter:description" content={seoDescription} />
    <meta name="twitter:image" content={ogImage} />

    <link rel="icon" href="/favicon.ico" type="image/x-icon" />

    <script type="application/ld+json" set:html={JSON.stringify(schemaData)} />
  </Fragment>

  <div class="bg-[#191B24]">
    <Header client:load />

    <main
      id="main-content"
      class="container mx-auto p-4 lg:px-8 lg:flex lg:gap-10 lg:py-20"
    >
      <div class="w-full lg:flex-[7] flex flex-col gap-6">
        <div class="px-0 lg:px-0">
          <CategoryMovies
            initialData={categoryData}
            initialSlug={slug}
            baseUrl={BASE_URL}
            initialLimit={limit}
            tittle={currentCategoryName}
            client:load
          />
        </div>
      </div>

      <div class="w-full lg:flex-[3] px-0 lg:px-0">
        <TopMovies movies={topmovies} />
      </div>
    </main>
  </div>
</BaseLayout>
